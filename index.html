<html>
  <!-- <link rel="stylesheet" type="text/css" href="main.css" /> -->
  <body>
    <div id="totalNumber">
      房间里总人数: 2
    </div>
    <div id="allUserNames">
      人员列表: 
    </div>
    <h2 id="myName"></h2>
    <form id="form" action=""><input id="input" autocomplete="off" /><button>发消息</button></form>
    <!-- <button id="query">查询</button> -->

    在这里改名字
    <form id="changeNameForm" action=""><input id="changeNameInput" autocomplete="off" /><button>改我的名字</button></form>


    <ul id="messages"></ul>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      function makeid(length) {
          let result = '';
          const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
          const charactersLength = characters.length;
          let counter = 0;
          while (counter < length) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
            counter += 1;
          }
          return result;
      }

      const myId = makeid(6);
      var socket = io()

      var myName = document.getElementById('myName')
      var form = document.getElementById('form')
      var input = document.getElementById('input')
      const queryButton = document.getElementById('query')
      const changeNameForm = document.getElementById('changeNameForm')
      const changeNameInput = document.getElementById('changeNameInput')
      const totalNumber = document.getElementById('totalNumber')
      const allUserNames = document.getElementById('allUserNames')

      if(form) form.addEventListener('submit', function (e) {
        e.preventDefault()
        if (input.value) {
          socket.emit('ToSMessage', {msg: input.value, fromId: myId})
          input.value = ''
        }
      })

      if(queryButton) queryButton.addEventListener('click', (e) => {
        e.preventDefault()
        socket.emit('ToSQueryButtonClicked', 123)
      })

      socket.emit('ToSChangeName', { newName: 'TUTUSHU', myId})

      changeNameForm.addEventListener('submit', function (e) {
        e.preventDefault()
        if (changeNameInput.value) {
          socket.emit('ToSChangeName', { newName: changeNameInput.value, myId})
          changeNameInput.value = ''
        }
      })

      socket.on('ToCMessage', function (msg) {
        printNewLine(msg)
      })

      socket.on('ToCSomeonesNameChanged', function (data) {
        if(data.myId == myId){
          myName.innerHTML = `My Name is ${data.newName}`
        }
      })

      socket.on('notifyCCurrentUserNames', function (msg) {
        totalNumber.innerHTML = `房间里总人数: ${msg.length}`
        allUserNames.innerHTML = `人员列表: ${msg}`
      })

      socket.on('notifyCCurrentUserCount', function (msg) {
        totalNumber.innerHTML = `房间里总人数: ${msg}`
      })

      socket.on('ToCQueryButtonClickedResponse', function (msg) {
        printNewLine(`查询结果: ${msg}`)
      })

      function printNewLine(msg) {
        msg = JSON.stringify(msg)
        var item = document.createElement('li')
        item.textContent = msg
        messages.appendChild(item)
        window.scrollTo(0, document.body.scrollHeight)
      }
    </script>
  </body>
</html>