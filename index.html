<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vote Form</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 600px;
    }
    th, td {
      border: 1px solid #333;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #f2f2f2;
    }
    /* fixed button on the right */
    .fixed-button {
      position: fixed;
      right: 20px;   /* distance from right edge */
      bottom: 20px;  /* distance from bottom */
    }
  </style>
</head>
<body>
  <h2 id="gameState">gameState</h2>

  <form id="lobby" style="margin-bottom:30px; border: 1px solid #ccc; border-radius: 8px; padding: 15px; background-color: #f9f9f9; box-shadow: 2px 2px 6px rgba(0,0,0,0.1);">
    <label for="lobbyTalbe">User List:</label>
    <table id="lobbyTalbe">
      <thead>
        <tr>
          <th>Number</th>
          <th>Name</th>
          <th>Game Role</th>
          <th>Off Duty This Round</th>
          <th>ID</th>
          <th>Manager Role</th>
        </tr>
      </thead>
      <tbody id="lobbyBody">
      </tbody>
    </table>
  </form>

  <div style="display: flex; gap: 30px;">
    <form id="gameForm" style="margin-bottom:30px; border: 1px solid #ccc; border-radius: 8px; padding: 15px; background-color: #f9f9f9; box-shadow: 2px 2px 6px rgba(0,0,0,0.1);">
      <label for="numberIWant">Number I Want:</label>
      <input type="number" id="numberIWant" name="numberIWant" />
      <br><br>
  
      <label for="myName">My Name:</label>
      <input type="text" id="myName" name="myName" />
      <br><br>
  
      <button id="joinGame" type="button">Join Game</button>
    </form>

    <form id="managerPanel" style="margin-bottom:30px; border: 1px solid #ccc; border-radius: 8px; padding: 15px; background-color: #f9f9f9; box-shadow: 2px 2px 6px rgba(0,0,0,0.1);">
      <label for="managerUserNumberInput">User Number:</label>
      <input type="text" id="managerUserNumberInput" name="managerUserNumberInput" />
      <label for="managerTextInput">Input(startGame/endGame/captain/mry/wyj/minimumGuns/xipai):</label>
      <input type="text" id="managerTextInput" name="managerTextInput" />

      <button id="managerSubmit" type="button">Submit</button>
    </form>
  </div>

  <form id="voteForm">
    <table id="voteTable">
      <tr id="userRow"></tr>
      <!-- vote rows will be added below -->
    </table>
  </form>

  <button class="fixed-button" type="button"
          onclick="addVoteRow([1,0,1,0,0,1,0,1,0])">
    Simulate Vote
  </button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    var socket = io()
    // initialize header row with 1â€“9
    

    // add a new vote row (array of 9 values: 0 or 1)
    function addVoteRow(votes) {
      const table = document.getElementById("voteTable");
      const row = document.createElement("tr");
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement("td");
        cell.textContent = votes[i] ?? "";
        row.appendChild(cell);
      }
      table.appendChild(row);
    }

    function generateId() {
      return Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,8);
    }
    function getOrCreateUserId() {
      let id = localStorage.getItem("userIdYuchen");
      if (!id) {
        id = generateId();
        localStorage.setItem("userIdYuchen", id);
      }
      return id;
    }

    ///////////////////////////////////////

    const joinGame = document.getElementById("joinGame");
    
    const numberIWant = document.getElementById("numberIWant");
    const myName = document.getElementById("myName");

    joinGame.addEventListener("click", () => {
      if (!numberIWant.value || !myName.value) {
        alert("Please enter a number and name before joining");
        return;
      }
      if (numberIWant.value <= 0 || numberIWant > 20) {
        alert("Please enter a 1-20 number");
        return;
      }
      socket.emit('ToSJoinGame', { id: getOrCreateUserId(), numberIWant: numberIWant.value, name: myName.value})
    });

    // Manager control panel START
    const managerUserNumberInput = document.getElementById("managerUserNumberInput");
    const managerTextInput = document.getElementById("managerTextInput");

    managerSubmit.addEventListener("click", () => {
      socket.emit('ToSManagerSubmit', { id: getOrCreateUserId(), input1: managerUserNumberInput.value, input2: managerTextInput.value})
    });
    
    // Manager control panel END

    const userRow = document.getElementById("userRow");
    for (let i = 1; i <= 9; i++) {
      const cell = document.createElement("td");
      cell.textContent = i;
      userRow.appendChild(cell);
    }


    socket.on('ToCCurrentGame', function (data) {
      clearLobby()
      let array = []
      for(const id in data.lobby){
        array.push(data.lobby[id])
      }
      array.sort((a, b) => a.numberIWant - b.numberIWant)
      for(const user of array){
        addRowToLobby(user)
      }

      updateGameState(data.state)
    })

    function clearLobby(info){
      const tbody = document.getElementById("lobbyBody");
      tbody.innerHTML = ''
    }

    function updateGameState(state){
      const gameState = document.getElementById("gameState");
      gameState.innerHTML = 'Game State: ' + state
    }

    function addRowToLobby(info){
      const tbody = document.getElementById("lobbyBody");
      const row = document.createElement("tr");
      const numberCell = document.createElement("td");
      numberCell.textContent = info.numberIWant
      const nameCell = document.createElement("td");
      nameCell.textContent = info.name;
      const gameRole = document.createElement("td");
      gameRole.textContent = info.gameRole;
      const offDuty = document.createElement("td");
      offDuty.textContent = info.offDuty? "Off Duty":"-";


      const idCell = document.createElement("td");
      idCell.textContent = info.id;
      const roleCell = document.createElement("td");
      roleCell.textContent = info.isManager? 'Manager':'-'

      row.appendChild(numberCell);
      row.appendChild(nameCell);
      row.appendChild(gameRole);
      row.appendChild(offDuty);
      row.appendChild(idCell);
      row.appendChild(roleCell);
      tbody.appendChild(row);
    }
  </script>
</body>
</html>
